#include "NTT.h"


const int root_table[501] = {-365560, 512419, -113617, 554318, -365560, 512419, -113617, 17927, 450867, 81326, 68170, 512419, 17927, 450867, 628375, 480727, -578530, -690013, -113617, 81326, 68170, -543576, 180792, -659118, -204785, 17927, 628375, 480727, -269355, -525409, 213215, 510644, 450867, -578530, -690013, 179004, 185689, -254133, -159781, 81326, -543576, 180792, -119436, 490357, -284093, 601627, 68170, -659118, -204785, -247060, 557284, -461545, 574263, -190483, -190483, -365560, -190483, -365560, 512419, -113617, -365560, 512419, -113617, 17927, 450867, 81326, 68170, 512419, 17927, 450867, 628375, 480727, -578530, -690013, -113617, 81326, 68170, -543576, 180792, -659118, -204785, 17927, 628375, 480727, -269355, -525409, 213215, 510644, 450867, -578530, -690013, 179004, 185689, -254133, -159781, 81326, -543576, 180792, -119436, 490357, -284093, 601627, 68170, -659118, -204785, -247060, 557284, -461545, 574263, 628375, -269355, -525409, -244905, 83234, 626897, -345136, 480727, 213215, 510644, -570682, 246681, 221704, -354057, -578530, 179004, 185689, 553573, -264918, 210714, -438381, -690013, -254133, -159781, 182092, -29335, 132634, -682178, -543576, -119436, 490357, -610382, 426334, -569350, -652451, 180792, -284093, 601627, -264329, -608986, 634818, -630298, -659118, -247060, 557284, -626522, -220964, -119514, 330192, -204785, -461545, 574263, -523051, -233230, -328895, 423759, -269355, -244905, 83234, -298012, -63527, -590140, 161615, -525409, 626897, -345136, 451958, 280496, -333822, -197942, 213215, -570682, 246681, 383399, 115315, -482064, 145486, 510644, 221704, -354057, 432415, 323746, 37636, -676718, 179004, 553573, -264918, -521028, -230099, 438821, -453510, 185689, 210714, -438381, -544593, 604400, 217432, -574977, -254133, 182092, -29335, -98954, -136666, -79403, 85921, -159781, 132634, -682178, -64753, 203385, 298754, 55059, -119436, -610382, 426334, -113205, -22719, 391482, -692316, 490357, -569350, -652451, 37237, 481440, -582559, 389717, -284093, -264329, -608986, -211618, -420251, -499892, 378910, 601627, 634818, -630298, -617891, -188373, 323869, -340182, -247060, -626522, -220964, 39993, -344052, -33979, 436473, 557284, -119514, 330192, -422532, 320050, 247565, 69937, -461545, -523051, -233230, -48491, 388598, -570492, -40143, 574263, -328895, 423759, -619062, -366028, 363049, 265157, -244905, -298012, -63527, -673766, -603182, 171313, 123643, 83234, -590140, 161615, -65397, 341826, -676486, -665777, 626897, 451958, 280496, 42703, -266361, 444941, 34721, -345136, -333822, -197942, 567951, 541071, -309513, 67727, -570682, 383399, 115315, -281712, 342235, -314352, -408905, 246681, -482064, 145486, 415357, -605222, -479787, 598920, 221704, 432415, 323746, 368882, 74988, 310997, -84663, -354057, 37636, -676718, -207863, -530523, -492624, -587966, 553573, -521028, -230099, 234314, 63853, -232191, -211682, -264918, 438821, -453510, 343915, 524722, 262302, -221848, 210714, -544593, 604400, 89861, -310145, -96952, -657661, -438381, 217432, -574977, -443121, -3055, 182920, 388199, 182092, -98954, -136666, 577336, 269165, -476377, -380109, -29335, -79403, 85921, -593587, 84844, 214376, -686174, 132634, -64753, 203385, 589629, 53963, 316768, 96677, -682178, 298754, 55059, -433897, -587743, -227754, -239846, -610382, -113205, -22719, 61334, -44511, 384047, -584992, 426334, 391482, -692316, -496965, -148896, -277294, -490988, -569350, 37237, 481440, 87060, 583279, 192563, 4730, -652451, -582559, 389717, -371104, -611450, 311581, -132528, -264329, -211618, -420251, 26977, 684677, 132148, -504340, -608986, -499892, 378910, -645985, -298482, 614756, -637307, 634818, -617891, -188373, 15274, 9215, -69612, -243055, -630298, 323869, -340182, 276523, -290507, 612567, 443897, -626522, 39993, -344052, 149502, 533614, 321194, -470709, -220964, -33979, 436473, -168782, -609475, -216039, 139587, -119514, -422532, 320050, -364516, -551798, -103455, 543940, 330192, 247565, 69937, 156628, 59015, 539629, 497237, -523051, -48491, 388598, -643369, 476939, 528415, -82678, -233230, -570492, -40143, 97630, -87934, 188968, -126534, -328895, -619062, -366028, -153078, 140181, -419890, 222480, 423759, 363049, 265157, 585669, 473703, 421971, -28992};

const int inv_factor_1_2_3[8] = {
-190483, 365560, -190483, 113617, 365560, -512419
};

const int inv_factor_4_5_6[64] = {
-190483, -190483, 365560, -190483, 113617, 365560, -512419, -68170, 204785, 659118, -574263, -557284, 461545, 247060, 113617, -68170, -81326, 204785, -180792, 659118, 543576, -450867, 690013, 578530, 159781, -185689, 254133, -179004, 365560, 113617, -512419, -68170, -450867, -81326, -17927, -81326, -180792, 543576, -601627, -490357, 284093, 119436, -512419, -450867, -17927, 690013, -480727, 578530, -628375, -17927, -480727, -628375, -510644, 525409, -213215, 269355
};

const int inv_factor_7_8_9[512] = {
-190483, -190483, 365560, -190483, 113617, 365560, -512419, -423759, -265157, -363049, 28992, -473703, -421971, -585669, -574263, -423759, 328895, -265157, 366028, -363049, 619062, 682178, -55059, -298754, 239846, 587743, 227754, 433897, 204785, -574263, 461545, -423759, 233230, 328895, 523051, 630298, 340182, -323869, -443897, 290507, -612567, -276523, 159781, 682178, -132634, -55059, -203385, -298754, 64753, 354057, 676718, -37636, 587966, 530523, 492624, 207863, -68170, 204785, 659118, -574263, -557284, 461545, 247060, -330192, -69937, -247565, -497237, -59015, -539629, -156628, -601627, 630298, -634818, 340182, 188373, -323869, 617891, 438381, 574977, -217432, -388199, 3055, -182920, 443121, 690013, 159781, 254133, 682178, 29335, -132634, -182092, 652451, -389717, 582559, 132528, 611450, -311581, 371104, -510644, 354057, -221704, 676718, -323746, -37636, -432415, 345136, 197942, 333822, -67727, -541071, 309513, -567951, 113617, -68170, -81326, 204785, -180792, 659118, 543576, 233230, 40143, 570492, 126534, 87934, -188968, -97630, -557284, -330192, 119514, -69937, -320050, -247565, 422532, 29335, -85921, 79403, 686174, -84844, -214376, 593587, -180792, -601627, 284093, 630298, 608986, -634818, 264329, 608986, -378910, 499892, 637307, 298482, -614756, 645985, -185689, 438381, -210714, 574977, -604400, -217432, 544593, -246681, -145486, 482064, -598920, 605222, 479787, -415357, -450867, 690013, 578530, 159781, -185689, 254133, -179004, 220964, -436473, 33979, -139587, 609475, 216039, 168782, -490357, 652451, 569350, -389717, -481440, 582559, -37237, 264918, 453510, -438821, 221848, -524722, -262302, -343915, -480727, -510644, -213215, 354057, -246681, -221704, 570682, -426334, 692316, -391482, 490988, 148896, 277294, 496965, 525409, 345136, -626897, 197942, -280496, 333822, -451958, -83234, -161615, 590140, 665777, -341826, 676486, 65397, 365560, 113617, -512419, -68170, -450867, -81326, -17927, 328895, 366028, 619062, -222480, -140181, 419890, 153078, 461545, 233230, 523051, 40143, -388598, 570492, 48491, -132634, -203385, 64753, -96677, -53963, -316768, -589629, 659118, -557284, 247060, -330192, 220964, 119514, 626522, -634818, 188373, 617891, 243055, -9215, 69612, -15274, 254133, 29335, -182092, -85921, 136666, 79403, 98954, -221704, -323746, -432415, 84663, -74988, -310997, -368882, -81326, -180792, 543576, -601627, -490357, 284093, 119436, 119514, -320050, 422532, -543940, 551798, 103455, 364516, 284093, 608986, 264329, -378910, 420251, 499892, 211618, -210714, -604400, 544593, 657661, 310145, 96952, -89861, 578530, -185689, -179004, 438381, 264918, -210714, -553573, 569350, -481440, -37237, -4730, -583279, -192563, -87060, -213215, -246681, 570682, -145486, -115315, 482064, -383399, -626897, -280496, -451958, -34721, 266361, -444941, -42703, -512419, -450867, -17927, 690013, -480727, 578530, -628375, 523051, -388598, 48491, 82678, -476939, -528415, 643369, 247060, 220964, 626522, -436473, 344052, 33979, -39993, -182092, 136666, 98954, 380109, -269165, 476377, -577336, 543576, -490357, 119436, 652451, -426334, 569350, 610382, 264329, 420251, 211618, 504340, -684677, -132148, -26977, -179004, 264918, -553573, 453510, 230099, -438821, 521028, 570682, -115315, -383399, 408905, -342235, 314352, 281712, -17927, -480727, -628375, -510644, 525409, -213215, 269355, 626522, 344052, -39993, 470709, -533614, -321194, -149502, 119436, -426334, 610382, 692316, 22719, -391482, 113205, -553573, 230099, 521028, 211682, -63853, 232191, -234314, -628375, 525409, 269355, 345136, -83234, -626897, 244905, 610382, 22719, 113205, 584992, 44511, -384047, -61334, 269355, -83234, 244905, -161615, 63527, 590140, 298012, 244905, 63527, 298012, -123643, 603182, -171313, 673766
};

extern void __asm_NTT_forward_16_small(const uint16_t *small_coeffs, const int *_root_table, int _MOD, int _Mprime, int *_Goodp1);
extern void __asm_NTT_forward_16(const uint16_t *big_coeffs, const int *_root_table, int _MOD, int _Mprime, int *_Goodp0);
extern void __asm_my_mul(int *_Goodp0, int *_Goodp1, int _Mprime, int _MOD);
extern void __asm_NTT_inv_1_2_3(int *_Goodp0, const int *_inv_factor_1_2_3, int _Mprime, int _MOD);
extern void __asm_NTT_inv_4_5_6(int *_Goodp0, const int *_inv_factor_4_5_6, int _Mprime, int _MOD);
extern void __asm_NTT_inv_7_8_9(int *_Goodp0, const int *_inv_factor_7_8_9, int _Mprime, int _MOD);
extern void __asm_final_map_and_pack(uint16_t *res_coeffs, int _R2invN, int *_Goodp0_2, int *Goodp0_0,
    int _Mprime, int _MOD, int _mask);
void Good_mul_768(uint16_t *res_coeffs, const uint16_t *small_coeffs, const uint16_t *big_coeffs)
{
    int mask = 0x07ff07ff;
    int Goodp0[3][512];
    int Goodp1[3][512];
    __asm_NTT_forward_16_small(small_coeffs, root_table, MOD, Mprime, &(Goodp1[0][0]));
    __asm_NTT_forward_16(big_coeffs, root_table, MOD, Mprime, &(Goodp0[0][0]));
    __asm_my_mul(&(Goodp0[1][0]), &(Goodp1[1][0]), Mprime, MOD);
    __asm_NTT_inv_1_2_3(&(Goodp0[0][0]), inv_factor_1_2_3, Mprime, MOD);
    __asm_NTT_inv_4_5_6(&(Goodp0[0][0]), inv_factor_4_5_6, Mprime, MOD);
    __asm_NTT_inv_7_8_9(&(Goodp0[0][0]), inv_factor_7_8_9, Mprime, MOD);

     __asm_final_map_and_pack(res_coeffs, R2invN, &Goodp0[2][0], &Goodp0[0][0],
                        Mprime, MOD, mask);
}
