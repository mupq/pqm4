
#include "NTT.h"

//[0-2] for 1_2_3, [3] for small, later 7*7 for 4_5_6, last 7*64 for 7_8_9
const int root_table[512] = {1774240, -1596516, -1645142, -2767649, 1774240, -1596516, -1645142, -1061880, -572044, 1663302, -2829611, -1596516, -1061880, -572044, 2746517, 2441293, -2178650, -654511, -1645142, 1663302, -2829611, 676663, 970, 12732, -1617737, -1061880, 2746517, 2441293, -1229846, 2259804, -2854448, 1910951, -572044, -2178650, -654511, 966293, 2427776, 215357, -1864385, 1663302, 676663, 970, -221355, -1440602, 430020, -2545498, -2829611, 12732, -1617737, 2273214, 2480814, 1586966, 1315693, 1808149, 1808149, 1774240, 1808149, 1774240, -1596516, -1645142, 1774240, -1596516, -1645142, -1061880, -572044, 1663302, -2829611, -1596516, -1061880, -572044, 2746517, 2441293, -2178650, -654511, -1645142, 1663302, -2829611, 676663, 970, 12732, -1617737, -1061880, 2746517, 2441293, -1229846, 2259804, -2854448, 1910951, -572044, -2178650, -654511, 966293, 2427776, 215357, -1864385, 1663302, 676663, 970, -221355, -1440602, 430020, -2545498, -2829611, 12732, -1617737, 2273214, 2480814, 1586966, 1315693, 2746517, -1229846, 2259804, 2377071, -2477766, 254226, -1505048, 2441293, -2854448, 1910951, 1137506, 1661989, -391820, -1883907, -2178650, 966293, 2427776, 2388128, -527434, -713632, -204492, -654511, 215357, -1864385, -534569, -2595149, -539973, -436955, 676663, -221355, -1440602, 729032, -347492, 2572538, -2494719, 970, 430020, -2545498, 872926, -1886604, 2657530, 2418403, 12732, 2273214, 2480814, -190397, 2701365, -1217933, -2797797, -1617737, 1586966, 1315693, -2571045, 2632281, -3582, -203007, -1229846, 2377071, -2477766, -2826458, 1937720, -576455, 2106695, 2259804, 254226, -1505048, -1370144, -261957, -1933451, -1674783, -2854448, 1137506, 1661989, 950436, -2336068, -2365140, -672708, 1910951, -391820, -1883907, -17288, 1667587, -1716630, 2146602, 966293, 2388128, -527434, -1040749, -245687, 2072073, -962140, 2427776, -713632, -204492, 859548, 252876, -1017870, 1373460, 215357, -534569, -2595149, 932800, 2690804, -100465, 2272405, -1864385, -539973, -436955, -358279, -2808464, -1147666, 2344559, -221355, 729032, -347492, -2338572, -1881746, 493514, 513873, -1440602, 2572538, -2494719, 311746, 792172, 1249748, -2835818, 430020, 872926, -1886604, 441764, 353502, 2068559, 292354, -2545498, 2657530, 2418403, -1455182, 1445554, -33224, -2845624, 2273214, -190397, 2701365, 2306472, -2565613, -875134, -2166268, 2480814, -1217933, -2797797, 2091759, -1434874, -2611319, -35288, 1586966, -2571045, 2632281, 2749751, 256384, -829626, -2427045, 1315693, -3582, -203007, -553, 1754431, -31640, -1687277, 2377071, -2826458, 1937720, -1153172, -557099, -1814002, 1662939, -2477766, -576455, 2106695, 2578480, 624185, -516765, -1316571, 254226, -1370144, -261957, -2650636, -1883289, 1990048, 1007585, -1505048, -1933451, -1674783, 577899, 1460045, 2218864, 2712191, 1137506, 950436, -2336068, -1514737, -942931, -1403692, 2794540, 1661989, -2365140, -672708, 749239, -217904, -1509270, 700219, -391820, -17288, 1667587, 716754, -2352583, 1506303, -1835865, -1883907, -1716630, 2146602, -14271, 2353607, 711219, 293967, 2388128, -1040749, -245687, -2092132, -728229, 916742, 2493113, -527434, 2072073, -962140, -1794183, 913752, -2842372, -244558, -713632, 859548, 252876, -2127857, -1313708, -618025, 58806, -204492, -1017870, 1373460, -1773530, 2320101, -2679198, 704895, -534569, 932800, 2690804, -612671, -1649762, 884106, -1272240, -2595149, -100465, 2272405, -757926, 2242984, 2612728, 2767326, -539973, -358279, -2808464, 1514908, -1054566, 685982, 1718027, -436955, -1147666, 2344559, 89295, -1827254, -710920, -224074, 729032, -2338572, -1881746, -1162508, -1201731, -238431, -300101, -347492, 493514, 513873, -2770471, -140682, 1317363, -2811192, 2572538, 311746, 792172, -100305, 1983042, -64518, -2356888, -2494719, 1249748, -2835818, -2144369, 2111429, -180524, -103658, 872926, 441764, 353502, 2597529, -1246843, -1754853, 1265522, -1886604, 2068559, 292354, -2408663, 128960, -1625272, -2369946, 2657530, -1455182, 1445554, -2294488, 2156968, 251312, 101135, 2418403, -33224, -2845624, 1991840, 1215040, -1708010, 1643573, -190397, 2306472, -2565613, -423243, -694912, 2337595, -1056852, 2701365, -875134, -2166268, -1022840, -2210204, 1787251, 272178, -1217933, 2091759, -1434874, 875290, 1453099, -408186, -231454, -2797797, -2611319, -35288, -1665107, -1628814, 1123515, -801190, -2571045, 2749751, 256384, 2764608, 2518346, -1143570, -465373, 2632281, -829626, -2427045, -918720, 581257, -985429, -1153727, -3582, -553, 1754431, -1989530, 2150483, -1433545, -2088640, -203007, -31640, -1687277, 85991, -1311749, 2737510, -702102};

const int inv_factor_1_2_3[8] = {
1808149, -1774240, 1808149, 1645142, -1774240, 1596516
};

const int inv_factor_4_5_6[64] = {
1808149, 1808149, -1774240, 1808149, 1645142, -1774240, 1596516, 2829611, 1617737, -12732, -1315693, -2480814, -1586966, -2273214, 1645142, 2829611, -1663302, 1617737, -970, -12732, -676663, 572044, 654511, 2178650, 1864385, -2427776, -215357, -966293, -1774240, 1645142, 1596516, 2829611, 572044, -1663302, 1061880, -1663302, -970, -676663, 2545498, 1440602, -430020, 221355, 1596516, 572044, 1061880, 654511, -2441293, 2178650, -2746517, 1061880, -2441293, -2746517, -1910951, -2259804, 2854448, 1229846
};

const int inv_factor_7_8_9[512] = {
1808149, 1808149, -1774240, 1808149, 1645142, -1774240, 1596516, 203007, 1687277, 31640, 702102, 1311749, -2737510, -85991, -1315693, 203007, 3582, 1687277, -1754431, 31640, 553, 436955, -2344559, 1147666, 224074, 1827254, 710920, -89295, 1617737, -1315693, -1586966, 203007, -2632281, 3582, 2571045, -2418403, 2845624, 33224, -1643573, -1215040, 1708010, -1991840, 1864385, 436955, 539973, -2344559, 2808464, 1147666, 358279, 1883907, -2146602, 1716630, -293967, -2353607, -711219, 14271, 2829611, 1617737, -12732, -1315693, -2480814, -1586966, -2273214, 2797797, 35288, 2611319, 801190, 1628814, -1123515, 1665107, 2545498, -2418403, -2657530, 2845624, -1445554, 33224, 1455182, 204492, -1373460, 1017870, -704895, -2320101, 2679198, 1773530, 654511, 1864385, -215357, 436955, 2595149, 539973, 534569, 2494719, 2835818, -1249748, 103658, -2111429, 180524, 2144369, -1910951, 1883907, 391820, -2146602, -1667587, 1716630, 17288, 1505048, 1674783, 1933451, -2712191, -1460045, -2218864, -577899, 1645142, 2829611, -1663302, 1617737, -970, -12732, -676663, -2632281, 2427045, 829626, 1153727, -581257, 985429, 918720, -2480814, 2797797, 1217933, 35288, 1434874, 2611319, -2091759, 2595149, -2272405, 100465, -2767326, -2242984, -2612728, 757926, -970, 2545498, -430020, -2418403, 1886604, -2657530, -872926, 1886604, -292354, -2068559, 2369946, -128960, 1625272, 2408663, -2427776, 204492, 713632, -1373460, -252876, 1017870, -859548, -1661989, 672708, 2365140, -700219, 217904, 1509270, -749239, 572044, 654511, 2178650, 1864385, -2427776, -215357, -966293, -2701365, 2166268, 875134, -272178, 2210204, -1787251, 1022840, 1440602, 2494719, -2572538, 2835818, -792172, -1249748, -311746, 527434, 962140, -2072073, 244558, -913752, 2842372, 1794183, -2441293, -1910951, 2854448, 1883907, -1661989, 391820, -1137506, 347492, -513873, -493514, 2811192, 140682, -1317363, 2770471, -2259804, 1505048, -254226, 1674783, 261957, 1933451, 1370144, 2477766, -2106695, 576455, 1316571, -624185, 516765, -2578480, -1774240, 1645142, 1596516, 2829611, 572044, -1663302, 1061880, 3582, -1754431, 553, 2088640, -2150483, 1433545, 1989530, -1586966, -2632281, 2571045, 2427045, -256384, 829626, -2749751, 539973, 2808464, 358279, -1718027, 1054566, -685982, -1514908, -12732, -2480814, -2273214, 2797797, -2701365, 1217933, 190397, -2657530, -1445554, 1455182, -101135, -2156968, -251312, 2294488, -215357, 2595149, 534569, -2272405, -2690804, 100465, -932800, 391820, -1667587, 17288, 1835865, 2352583, -1506303, -716754, -1663302, -970, -676663, 2545498, 1440602, -430020, 221355, 1217933, 1434874, -2091759, 231454, -1453099, 408186, -875290, -430020, 1886604, -872926, -292354, -353502, -2068559, -441764, 713632, -252876, -859548, -58806, 1313708, 618025, 2127857, 2178650, -2427776, -966293, 204492, 527434, 713632, -2388128, -2572538, -792172, -311746, 2356888, -1983042, 64518, 100305, 2854448, -1661989, -1137506, 672708, 2336068, 2365140, -950436, -254226, 261957, 1370144, -1007585, 1883289, -1990048, 2650636, 1596516, 572044, 1061880, 654511, -2441293, 2178650, -2746517, 2571045, -256384, -2749751, 465373, -2518346, 1143570, -2764608, -2273214, -2701365, 190397, 2166268, 2565613, 875134, -2306472, 534569, -2690804, -932800, 1272240, 1649762, -884106, 612671, -676663, 1440602, 221355, 2494719, 347492, -2572538, -729032, -872926, -353502, -441764, -1265522, 1246843, 1754853, -2597529, -966293, 527434, -2388128, 962140, 245687, -2072073, 1040749, -1137506, 2336068, -950436, -2794540, 942931, 1403692, 1514737, 1061880, -2441293, -2746517, -1910951, -2259804, 2854448, 1229846, 190397, 2565613, -2306472, 1056852, 694912, -2337595, 423243, 221355, 347492, -729032, -513873, 1881746, -493514, 2338572, -2388128, 245687, 1040749, -2493113, 728229, -916742, 2092132, -2746517, -2259804, 1229846, 1505048, 2477766, -254226, -2377071, -729032, 1881746, 2338572, 300101, 1201731, 238431, 1162508, 1229846, 2477766, -2377071, -2106695, -1937720, 576455, 2826458, -2377071, -1937720, 2826458, -1662939, 557099, 1814002, 1153172
};


extern void __asm_NTT_forward_16_small(const uint16_t *small_coeffs, const int *_root_table, int _MOD, int _Mprime, int *_Goodp1);
extern void __asm_NTT_forward_16(const uint16_t *big_coeffs, const int *_root_table, int _MOD, int _Mprime, int *_Goodp0);
extern void __asm_my_mul(int *_Goodp0, int *_Goodp1, int _Mprime, int _MOD);
extern void __asm_NTT_inv_1_2_3(int *_Goodp0, const int *_inv_factor_1_2_3, int _Mprime, int _MOD);
extern void __asm_NTT_inv_4_5_6(int *_Goodp0, const int *_inv_factor_4_5_6, int _Mprime, int _MOD);
extern void __asm_NTT_inv_7_8_9(int *_Goodp0, const int *_inv_factor_7_8_9, int _Mprime, int _MOD);
extern void __asm_final_map_and_pack(uint16_t *res_coeffs, int _R2invN, int *_Goodp0_2, int *Goodp0_0,
    int _Mprime, int _MOD, int _mask);
void Good_mul_768(uint16_t *res_coeffs, const uint16_t *small_coeffs, const uint16_t *big_coeffs)
{
    int mask = 0x1fff1fff;
    static int Goodp0[3][512];
    static int Goodp1[3][512];
    __asm_NTT_forward_16_small(small_coeffs, root_table, MOD, Mprime, &(Goodp1[0][0]));
    __asm_NTT_forward_16(big_coeffs, root_table, MOD, Mprime, &(Goodp0[0][0]));
    __asm_my_mul(&(Goodp0[1][0]), &(Goodp1[1][0]), Mprime, MOD);
    __asm_NTT_inv_1_2_3(&(Goodp0[0][0]), inv_factor_1_2_3, Mprime, MOD);
    __asm_NTT_inv_4_5_6(&(Goodp0[0][0]), inv_factor_4_5_6, Mprime, MOD);
    __asm_NTT_inv_7_8_9(&(Goodp0[0][0]), inv_factor_7_8_9, Mprime, MOD);

    __asm_final_map_and_pack(res_coeffs, R2invN, &Goodp0[2][0], &Goodp0[0][0],
                       Mprime, MOD, mask);
}
